# AUTOGENERATED! DO NOT EDIT! File to edit: ../notebooks/01_dataframe.ipynb.

# %% auto 0
__all__ = ['logger', 'create_pit_stop_times_dataframe_for_a_race', 'drop_red_flags',
           'create_pit_stop_times_dataframe_for_a_season', 'fetch_season_race_codes',
           'build_pit_stop_data_for_year_range']

# %% ../notebooks/01_dataframe.ipynb 48
def create_pit_stop_times_dataframe_for_a_race(session_laps_df):
    
    """
    Creates DataFrame with PitStopTimes column from a race session.
    INPUT: Race session from fastF1
    OUTPUT: DataFrame with PitStopTime column calculated.
    """
    
    # Pick laps with PitTimeIn and PitTImeOut
    pit_stop_laps = session_laps_df.pick_box_laps(which='both').sort_values(by=['Driver','LapNumber'])
    pit_stop_laps.reset_index(inplace=True)
    
    # Create new column and calculate PitStopTIme
    pit_stop_laps.loc[pit_stop_laps['Driver'].shift(-1) == pit_stop_laps['Driver'], 'PitStopTime'] = pit_stop_laps['PitOutTime'].shift(-1) - pit_stop_laps['PitInTime']
    pit_stop_laps = pit_stop_laps.dropna(subset=['PitStopTime'])

    return pit_stop_laps

# %% ../notebooks/01_dataframe.ipynb 50
def drop_red_flags(pit_stop_laps):
    """
    Drop entries which contain TrackStatus 5
    """
    
    # Drop entries with Red flags
    pit_stop_laps = pit_stop_laps[~pit_stop_laps.TrackStatus.str.contains("5")]
    
    return pit_stop_laps

# %% ../notebooks/01_dataframe.ipynb 54
import fastf1
import pandas as pd
import sys

import logging
logger = logging.getLogger(__name__)
# logging.basicConfig(level=logging.DEBUG)

# %% ../notebooks/01_dataframe.ipynb 62
# Function to create pit stop times for race session in a year

def create_pit_stop_times_dataframe_for_a_season(year: int, season_race_codes: pd.Series) -> pd.DataFrame:
    """
    Create a concatenated dataframe which contains the pit stop times from all races in a year.
    INPUT:
        - year: [int]
        - season_race_code: [int] code to be used by get_session() to get the race laps.
    """
    pit_stop_df = pd.DataFrame()
    for race_code in season_race_codes:
        session = fastf1.get_session(year, race_code, 'R')
#         session.load(laps=True, telemetry=True, weather=True, messages=False, livedata=False)
        session.load()
        race_name = session.event.EventName
        race_country = session.event.Location
        logging.info(f"Race code: {race_code}")
        logging.info(f"Race Name: {race_name}")
        logging.info(f"Location: {race_country}")
        logging.info("---------------------------")
        session_pit_stops_df = create_pit_stop_times_dataframe_for_a_race(session.laps)
        session_pit_stops_df = drop_red_flags(session_pit_stops_df)
        pit_stop_df = pd.concat([pit_stop_df, session_pit_stops_df])
    return pit_stop_df

# %% ../notebooks/01_dataframe.ipynb 66
# Function to extract race codes for a range of years

def fetch_season_race_codes(year: int) ->pd.Series:
    """
    Returns the race codes for a season given the year.
    """
    year = 2024
    event_schedule = fastf1.get_event_schedule(year)
    season_race_codes = event_schedule.iloc[1:, 0]
    return season_race_codes

# %% ../notebooks/01_dataframe.ipynb 68
def build_pit_stop_data_for_year_range(start_year: int, end_year: int) -> pd.DataFrame:
    """
    Builds a complete feature matrix of F1 pit stop times by iterating over 
    a specified range of years.

    INPUT:
        start_year (int): The first year (inclusive) to process.
        end_year (int): The last year (inclusive) to process.

    OUTPUT:
        pd.DataFrame: A single DataFrame containing all collected and processed 
                      pit stop records.
    """
    
    all_years_data = []
    
    # Loop from start_year up to and including end_year
    for year in range(start_year, end_year + 1):
        try:
            # Get race codes for the season
            logger.info(f"Fetching season race codes for {year}")
            season_race_codes = fetch_season_race_codes(year)
            logger.info("====> Done <====")
            
            # Get all pit stops for that year
            logger.info(f"Fetching all pit stop times for {year}")
            season_df = create_pit_stop_times_dataframe_for_a_season(year, season_race_codes)
            logger.info("====> Done <====")

            all_years_data.append(yearly_df)
            print(f"Successfully processed {year}. Total pit stops collected: {len(season_df)}")
        except Exception as e:
            print(f"ERROR processing year {year}: {e}")
            # Continue to the next year even if one fails
            continue

    # Concatenate all yearly DataFrames into one jumbo dataset
    if all_years_data:
        jumbo_df = pd.concat(all_years_data, ignore_index=True)
        print("\n--- Data Collection Complete ---")
        print(f"Total rows collected ({start_year}-{end_year}): {len(jumbo_df)}")
        return jumbo_df
    else:
        print("\nNo data collected.")
        return pd.DataFrame()
